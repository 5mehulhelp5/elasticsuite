<?xml version="1.0"?>
<!--
/**
 * Copyright Â© 2015 Magento. All rights reserved.
 * See COPYING.txt for license details.
 */
-->
<requests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="urn:magento:framework:Search/etc/search_request.xsd">
    
    <request name="quick_search_container" index="catalog_product" type="product">
        <from>0</from>
        <size>20</size>
        <dimensions>
            <dimension name="scope" value="default"/>
        </dimensions>
        <query reference="query" />
        <filter reference="filter" />
        <queries>
            <query xsi:type="filteredQuery" name="query">
                <query reference="fulltext_query"/>
                <filter reference="base_filters" />
            </query>
            <query xsi:type="boolQuery" name="filter">
                <query clause="must" reference="price_nested_filter"/>
                <!-- Placeholder for multiselect attributes facets -->
            </query>
            <query xsi:type="matchQuery" queryText="$search_term$" name="fulltext_query" field="search"/>
            <query xsi:type="boolQuery" name="base_filters">
                <query clause="must" reference="category_nested_filter" />
                <query clause="must" reference="visibility_filter"/>
            </query>
            
            <query xsi:type="nestedQuery" name="category_nested_filter" path="category">
                <query reference="category_id_filter" />
            </query>
            <query xsi:type="termsQuery" name="category_id_filter" field="category.category_id" values="$category_ids$" />
            
            <query xsi:type="nestedQuery" name="price_nested_filter" path="price">
                <query reference="price_filter" />
            </query> 
            <query xsi:type="boolQuery" name="price_filter_conditions">
                <query clause="must" reference="price_customer_group" />
                <query clause="must" reference="price_filter" />
            </query> 
            <query xsi:type="termsQuery" name="price_customer_group_filter" field="price.customer_group_id" values="$customer_group_id$" />
            <query xsi:type="rangeQuery" name="price_filter" field="price.price" from="$price.from$" to="$price.to$" />
            
            <query xsi:type="termsQuery" name="visibility_filter" field="visibility" values="$visibility$"/>
            
        </queries>
        <sortOrders>
            <sortOrder xsi:type="standardSortOrder" name="relevance" field="_score" direction="$sortOrder.direction$" />
            <sortOrder xsi:type="nestedSortOrder" name="position" field="category.position" nestedPath="category" direction="$sortOrder.direction$">
                <nestedFilter reference="category_id_filter" />
            </sortOrder>
            <sortOrder xsi:type="nestedSortOrder" name="price" field="price.price" nestedPath="price" direction="$sortOrder.direction$">
                <nestedFilter reference="price_customer_group_filter" />
            </sortOrder>
        </sortOrders>
        <aggregations>
            <bucket name="price_bucket" field="price" xsi:type="dynamicBucket" method="$price_dynamic_algorithm$" />
            <bucket name="category_bucket" field="category_ids" xsi:type="termBucket" size="10"/>
        </aggregations>
    </request>
    
    <request name="advanced_search_container" index="catalog_product" type="product">
        <from>0</from>
        <size>20</size>
        <dimensions>
            <dimension name="scope" value="default"/>
        </dimensions>
        
        <!-- 
        @todo: Map queries and aggregations.
         -->
    </request>
    
    <request name="catalog_view_container" index="catalog_product" type="product">
        <from>0</from>
        <size>20</size>
        <dimensions>
            <dimension name="scope" value="default"/>
        </dimensions>
        <query reference="query" />
        <filter reference="filter" />
        <queries>
            <query xsi:type="boolQuery" name="query">
                <query clause="must" reference="category_nested_filter" />
                <query clause="must" reference="visibility_filter"/>
            </query>
            <query xsi:type="boolQuery" name="filter">
                <query clause="must" reference="price_nested_filter" />
                <!-- Placeholder for multiselect attributes facets -->
            </query>
            
            <query xsi:type="nestedQuery" name="category_nested_filter" path="category">
                <query reference="category_id_filter" />
            </query>
            <query xsi:type="termsQuery" name="category_id_filter" field="category.category_id" values="$category_ids$" />
            
            <query xsi:type="nestedQuery" name="price_nested_filter" path="price">
                <query reference="price_filter" />
            </query> 
            <query xsi:type="boolQuery" name="price_filter_conditions">
                <query clause="must" reference="price_customer_group" />
                <query clause="must" reference="price_filter" />
            </query> 
            <query xsi:type="termsQuery" name="price_customer_group_filter" field="price.customer_group_id" values="$customer_group_id$" />
            <query xsi:type="rangeQuery" name="price_filter" field="price.price" from="$price.from$" to="$price.to$" />
            
            <query xsi:type="termsQuery" name="visibility_filter" field="visibility" values="$visibility$"/>
        </queries>
        <sortOrders>
            <sortOrder xsi:type="standardSortOrder" name="relevance" field="_score" direction="$sortOrder.direction$" />
            <sortOrder xsi:type="nestedSortOrder" name="position" field="category.position" nestedPath="category" direction="$sortOrder.direction$">
                <nestedFilter reference="category_id_filter" />
            </sortOrder>
            <sortOrder xsi:type="nestedSortOrder" name="price" field="price.price" nestedPath="price" direction="$sortOrder.direction$">
                <nestedFilter reference="price_customer_group_filter" />
            </sortOrder>
        </sortOrders>
        <aggregations>
            <bucket name="price_bucket" field="price" xsi:type="dynamicBucket" method="$price_dynamic_algorithm$" />
            <bucket name="category_bucket" field="category_ids" xsi:type="termBucket" size="10"/>
        </aggregations>
    </request>
    
</requests>
